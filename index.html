<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GDIS Solar - Proposta</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap">
  <style>
    /* ---------------------- */
    /* Cores e Variáveis      */
    /* ---------------------- */
    :root {
      /* Tema padrão: Alta Performance */
      --main-blue: #123d8c;
      --dark-blue: #0a2a5c;
      --highlight-color: #ff7a29;
      --secondary-highlight: #ff7a29;
      --white: #ffffff;
      --light-gray: #f4f6fb;
      --muted-text: #6f7d95;
      --nav-bg: rgba(18, 61, 140, 0.9);
      --gradient-bg: linear-gradient(135deg, var(--main-blue) 0%, var(--dark-blue) 50%, #174296 100%);
      --radius: 22px;
      --shadow: 0 8px 20px rgba(0, 0, 0, .15);
    }

    body.economic-theme {
      /* NOVO TEMA: Econômico */
      --main-blue: #598c76;
      --dark-blue: #315e4a;
      --highlight-color: #79c9a0;
      --secondary-highlight: #598c76;
      --white: #ffffff;
      --light-gray: #f7faf7;
      --muted-text: #6f7d95;
      --nav-bg: rgba(89, 140, 118, 0.9);
      --gradient-bg: linear-gradient(135deg, var(--main-blue) 0%, var(--dark-blue) 50%, #4c6f5d 100%);
    }

    /* ---------------------- */
    /* Estilos Gerais         */
    /* ---------------------- */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', sans-serif;
      line-height: 1.6;
      transition: background-color 0.5s ease;
      color: var(--dark-blue);
      background: var(--light-gray);
    }

    /* Esconde as seções de proposta por padrão */
    .proposal-container {
      display: none;
      background: var(--light-gray);
      color: var(--dark-blue);
    }

    .proposal-section {
      display: none;
    }

    /* Estilos para o container do formulário */
    .form-container {
      background: var(--gradient-bg);
      color: var(--white);
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      flex-direction: column;
      transition: background 0.5s ease;
    }

    .form-box {
      width: 100%;
      max-width: 500px;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      padding: 40px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      text-align: center;
    }

    .form-box .logo img {
      height: 80px;
      margin-bottom: 20px;
    }

    .form-box h1 {
      font-size: clamp(28px, 5vw, 40px);
      font-weight: 800;
      margin-bottom: 10px;
    }

    .form-box p {
      font-size: 16px;
      margin-bottom: 30px;
      opacity: 0.8;
    }

    .search-form {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .search-form input[type="text"] {
      width: 100%;
      padding: 15px 20px;
      border-radius: 50px;
      border: none;
      font-size: 16px;
      background: rgba(255, 255, 255, 0.2);
      color: var(--white);
      transition: background 0.3s ease;
    }

    .search-form input[type="text"]::placeholder {
      color: rgba(255, 255, 255, 0.7);
    }

    .search-form input[type="text"]:focus {
      outline: none;
      background: rgba(255, 255, 255, 0.3);
    }

    .search-form button {
      width: 100%;
      padding: 15px 20px;
      border-radius: 50px;
      border: none;
      font-size: 18px;
      font-weight: 700;
      cursor: pointer;
      background: var(--highlight-color);
      color: var(--white);
      transition: background 0.3s ease, transform 0.1s;
    }

    .search-form button:hover {
      background: var(--secondary-highlight);
    }

    .search-form button:active {
      transform: translateY(1px);
    }

    .message-box {
      margin-top: 20px;
      padding: 15px;
      background: rgba(255, 0, 0, 0.2);
      border-radius: 8px;
      display: none;
      font-size: 14px;
      font-weight: 500;
      border: 1px solid rgba(255, 0, 0, 0.4);
    }

    /* ---------------------- */
    /* Componentes da Proposta*/
    /* ---------------------- */
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    .clean-section {
      background: var(--white);
      margin: 40px 0;
      padding: 60px 20px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      transition: background-color 0.5s ease;
    }

    section {
      position: relative;
      overflow: hidden;
    }

    .payback-section-bg {
      background: var(--dark-blue);
      color: var(--white);
      margin: 40px 0;
      padding: 60px 20px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      transition: background-color 0.5s ease;
    }

    .payback-section-bg h2 {
      color: var(--white);
    }

    .payback-section-bg p {
      color: rgba(255, 255, 255, 0.8);
    }

    .details-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-top: 40px;
      text-align: left;
    }

    .detail-card {
      background: var(--light-gray);
      padding: 25px;
      border-radius: var(--radius);
      border: 1px solid #e0e0e0;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .detail-card::before {
      content: '';
      position: absolute;
      top: -10px;
      left: -10px;
      width: 30px;
      height: 30px;
      background: var(--highlight-color);
      border-radius: 50%;
      filter: blur(15px);
      transition: transform 0.3s ease;
    }

    .detail-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    }

    .detail-card h3 {
      font-size: 18px;
      margin-bottom: 5px;
      color: var(--main-blue);
    }

    .detail-card p {
      font-size: 14px;
      color: var(--muted-text);
      text-align: left;
    }

    .table-container {
      width: 100%;
      overflow-x: auto;
      margin-top: 40px;
    }

    .proposal-table {
      width: 100%;
      border-collapse: collapse;
      text-align: left;
      min-width: 600px;
    }

    .proposal-table th,
    .proposal-table td {
      padding: 15px;
      border-bottom: 1px solid #e0e0e0;
    }

    .proposal-table th {
      background: var(--main-blue);
      color: var(--white);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .proposal-table td {
      background: var(--white);
      transition: background-color 0.3s ease;
    }

    .proposal-table tr:hover td {
      background-color: var(--light-gray);
    }

    .proposal-table tfoot td {
      font-weight: 700;
      background: var(--main-blue);
      color: var(--white);
      border-bottom: none;
    }

    .contact-card {
      background: var(--gradient-bg);
      color: var(--white);
      text-align: center;
      padding: 40px 20px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }

    /* Estilos para o menu de navegação */
    .nav {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      background: var(--nav-bg);
      backdrop-filter: blur(10px);
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      z-index: 1000;
    }

    .nav-links {
      display: flex;
      justify-content: center;
      padding: 10px 0;
      list-style: none;
      margin: 0;
    }

    .nav-links li a {
      color: var(--white);
      text-decoration: none;
      padding: 10px 20px;
      display: block;
      font-size: 14px;
      font-weight: 500;
      transition: background-color 0.3s ease;
      border-radius: 20px;
    }

    .nav-links li a:hover {
      background-color: rgba(255, 255, 255, 0.2);
    }
  </style>
</head>

<body>

  <!-- Container do Formulário de Busca -->
  <div class="form-container" id="form-container">
    <div class="form-box">
      <div class="logo">
        <img src="https://placehold.co/80x80/123d8c/ffffff?text=GDIS" alt="Logo GDIS Solar">
      </div>
      <h1>Bem-vindo ao Portal GDIS</h1>
      <p>Consulte sua proposta técnica e comercial de energia solar com o ID do seu projeto.</p>
      <form class="search-form" id="search-form">
        <input type="text" id="project-id-input" placeholder="Digite o ID do Projeto" required>
        <button type="submit">Consultar Proposta</button>
      </form>
      <div class="message-box" id="message-box"></div>
    </div>
  </div>

  <!-- Container da Proposta (Inicialmente oculto) -->
  <div class="proposal-container" id="proposal-container">
    <header>
      <div class="nav">
        <ul class="nav-links">
          <li><a href="#proposta">Proposta</a></li>
          <li><a href="#detalhes">Detalhes</a></li>
          <li><a href="#tabela-precos">Tabela de Preços</a></li>
          <li><a href="#geracao">Geração</a></li>
          <li><a href="#contato">Contato</a></li>
        </ul>
      </div>
    </header>

    <main class="container">
      <section id="proposta" class="clean-section">
        <h2>Proposta Técnica e Comercial</h2>
        <p id="proposal-name"></p>
        <p id="proposal-description"></p>
        <p id="proposal-status"></p>
        <p id="proposal-link"></p>
      </section>

      <section id="detalhes" class="clean-section">
        <h2>Detalhes da Proposta</h2>
        <div class="details-grid" id="details-grid">
          <!-- Detalhes serão injetados aqui via JS -->
        </div>
      </section>

      <section id="tabela-precos" class="clean-section">
        <h2>Tabela de Preços</h2>
        <div class="table-container">
          <table class="proposal-table">
            <thead>
              <tr>
                <th>Categoria</th>
                <th>Item</th>
                <th>Qtd</th>
                <th>Custo Unitário</th>
                <th>Custo Total</th>
              </tr>
            </thead>
            <tbody id="pricing-table-body">
              <!-- Linhas da tabela serão injetadas aqui via JS -->
            </tbody>
            <tfoot>
              <tr>
                <td colspan="4">Total</td>
                <td id="total-cost"></td>
              </tr>
            </tfoot>
          </table>
        </div>
      </section>

      <section id="geracao" class="payback-section-bg">
        <h2>Simulação de Geração</h2>
        <p id="geracao-info"></p>
      </section>

      <section id="contato" class="clean-section">
        <div class="contact-card">
          <h2>Fale Conosco</h2>
          <p>Entre em contato para tirar suas dúvidas e fechar negócio.</p>
          <button class="btn btn-primary">Entrar em Contato</button>
        </div>
      </section>
    </main>
  </div>

  <script>
    // Seleção de elementos do DOM
    const searchForm = document.getElementById('search-form');
    const projectIdInput = document.getElementById('project-id-input');
    const messageBox = document.getElementById('message-box');
    const formContainer = document.getElementById('form-container');
    const proposalContainer = document.getElementById('proposal-container');

    const proposalName = document.getElementById('proposal-name');
    const proposalDescription = document.getElementById('proposal-description');
    const proposalStatus = document.getElementById('proposal-status');
    const proposalLink = document.getElementById('proposal-link');
    const detailsGrid = document.getElementById('details-grid');
    const pricingTableBody = document.getElementById('pricing-table-body');
    const totalCostCell = document.getElementById('total-cost');
    const geracaoInfo = document.getElementById('geracao-info');
    
    // Funções de tema (mantidas do código original)
    const highPerformanceOption = document.getElementById('high-performance-option');
    const economicOption = document.getElementById('economic-option');
    
    function setTheme(themeName) {
      document.body.className = '';
      if (themeName === 'economico') {
        document.body.classList.add('economic-theme');
      }
    }

    if(highPerformanceOption) {
      highPerformanceOption.addEventListener('click', () => setTheme('alta_performance'));
    }
    if(economicOption) {
      economicOption.addEventListener('click', () => setTheme('economico'));
    }

    /**
     * Consulta a proposta ativa de um cliente chamando o backend.
     * @param {string} projectId - O ID do projeto.
     * @returns {Promise<Object|null>} Um objeto com a proposta ou null em caso de falha.
     */
    async function consultarProposta(projectId) {
      const backendUrl = `https://gdissolarproposta.vercel.app/api/proposta?projectId=${projectId}`;
      
      try {
        const res = await fetch(backendUrl);
        
        if (!res.ok) {
          let errorMessage = `Erro HTTP: ${res.status}`;
          try {
            const errorBody = await res.json();
            if (errorBody && errorBody.error) {
              errorMessage = `Erro: ${errorBody.error}`;
            } else if (errorBody && errorBody.message) {
              errorMessage = `Erro: ${errorBody.message}`;
            }
          } catch (e) {
            // Se não for um JSON válido, a mensagem genérica será mantida
          }
          throw new Error(errorMessage);
        }
        
        const dados = await res.json();
        
        // CORREÇÃO: Conforme o log do Vercel, a proposta está aninhada em `dados.data`.
        // Precisamos retornar esse objeto aninhado.
        return dados.data;
      } catch (err) {
        console.error("Erro ao consultar proposta:", err);
        throw err;
      }
    }

    /**
     * Renderiza os detalhes da proposta na página.
     * @param {Object} proposta - O objeto da proposta retornado pela API.
     */
    function renderizarProposta(proposta) {
        // Mostra o container da proposta e esconde o formulário
        formContainer.style.display = 'none';
        proposalContainer.style.display = 'block';

        // Atualiza as informações básicas
        proposalName.textContent = proposta.name || "N/A";
        proposalDescription.textContent = proposta.description || "Sem descrição.";
        proposalStatus.textContent = `Status: ${proposta.status}`;
        proposalLink.innerHTML = proposta.linkPdf ? `<a href="${proposta.linkPdf}" target="_blank">Ver PDF</a>` : '';

        // Renderiza os detalhes da grade (customFields)
        detailsGrid.innerHTML = '';
        if (proposta.customFields && Array.isArray(proposta.customFields) && proposta.customFields.length > 0) {
            proposta.customFields.forEach(field => {
                const card = document.createElement('div');
                card.classList.add('detail-card');
                card.innerHTML = `<h3>${field.key}</h3><p>${field.formattedValue}</p>`;
                detailsGrid.appendChild(card);
            });
        } else {
            detailsGrid.innerHTML = '<p style="text-align: center; width: 100%;">Não há detalhes adicionais.</p>';
        }

        // Renderiza a tabela de preços
        pricingTableBody.innerHTML = '';
        let totalCost = 0;
        if (proposta.pricingTable && Array.isArray(proposta.pricingTable) && proposta.pricingTable.length > 0) {
            proposta.pricingTable.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.category || "N/A"}</td>
                    <td>${item.item || "N/A"}</td>
                    <td>${item.qnt || "N/A"}</td>
                    <td>R$ ${parseFloat(item.unitCost).toFixed(2) || "N/A"}</td>
                    <td>R$ ${parseFloat(item.totalCost).toFixed(2) || "N/A"}</td>
                `;
                pricingTableBody.appendChild(row);
                totalCost += parseFloat(item.totalCost);
            });
        } else {
            pricingTableBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Tabela de preços não disponível.</td></tr>';
        }
        totalCostCell.textContent = `R$ ${totalCost.toFixed(2)}`;
        
        // Renderiza a simulação de geração
        if (proposta.generation && Array.isArray(proposta.generation) && proposta.generation.length > 0) {
            const geracaoMedia = proposta.generation.find(g => g.key === 'anual_media');
            if (geracaoMedia) {
                 geracaoInfo.textContent = `Geração média anual: ${geracaoMedia.formattedValue} kWh.`;
            } else {
                 geracaoInfo.textContent = 'Dados de geração não disponíveis.';
            }
        } else {
            geracaoInfo.textContent = 'Dados de geração não disponíveis.';
        }
    }

    // Lida com o envio do formulário
    searchForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const projectId = projectIdInput.value.trim();
        
        // Limpa a caixa de mensagens
        messageBox.style.display = 'none';
        messageBox.textContent = '';
        
        if (!projectId) {
            messageBox.textContent = 'Por favor, digite um ID de projeto.';
            messageBox.style.display = 'block';
            return;
        }

        // Simula um estado de carregamento
        searchForm.querySelector('button').textContent = 'Consultando...';
        searchForm.querySelector('button').disabled = true;

        try {
            const proposta = await consultarProposta(projectId);
            if (proposta) {
                renderizarProposta(proposta);
            } else {
                messageBox.textContent = 'Proposta não encontrada para o projeto especificado.';
                messageBox.style.display = 'block';
            }
        } catch (err) {
            messageBox.textContent = `Erro ao carregar proposta: ${err.message}`;
            messageBox.style.display = 'block';
        } finally {
            searchForm.querySelector('button').textContent = 'Consultar Proposta';
            searchForm.querySelector('button').disabled = false;
        }
    });
  </script>
</body>
</html>
