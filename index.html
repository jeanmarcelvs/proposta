<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GDIS Solar - Proposta</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap">
  <style>
    /* ---------------------- */
    /* Cores e Variáveis      */
    /* ---------------------- */
    :root {
      /* Tema padrão: Alta Performance */
      --main-blue: #123d8c;
      --dark-blue: #0a2a5c;
      --highlight-color: #ff7a29;
      --secondary-highlight: #ff7a29;
      --white: #ffffff;
      --light-gray: #f4f6fb;
      --muted-text: #6f7d95;
      --nav-bg: rgba(18, 61, 140, 0.9);
      --gradient-bg: linear-gradient(135deg, var(--main-blue) 0%, var(--dark-blue) 50%, #174296 100%);
      --radius: 22px;
      --shadow: 0 8px 20px rgba(0, 0, 0, .15);
    }

    body.economic-theme {
      /* NOVO TEMA: Econômico */
      --main-blue: #598c76;
      --dark-blue: #315e4a;
      --highlight-color: #79c9a0;
      --secondary-highlight: #598c76;
      --white: #ffffff;
      --light-gray: #f7faf7;
      --muted-text: #6f7d95;
      --nav-bg: rgba(89, 140, 118, 0.9);
      --gradient-bg: linear-gradient(135deg, var(--main-blue) 0%, var(--dark-blue) 50%, #487360 100%);
      --radius: 22px;
      --shadow: 0 8px 20px rgba(0, 0, 0, .15);
    }

    /* ---------------------- */
    /* Estilos Gerais         */
    /* ---------------------- */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', sans-serif;
      line-height: 1.6;
      color: #333;
      background-color: var(--light-gray);
      transition: background-color 0.3s ease-in-out;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem;
    }

    .header {
      background: var(--nav-bg);
      color: var(--white);
      padding: 1.5rem 2rem;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      margin-bottom: 2rem;
      backdrop-filter: blur(10px);
      position: sticky;
      top: 1.5rem;
      z-index: 1000;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background-color 0.3s ease-in-out;
    }

    .header .logo {
      font-weight: 800;
      font-size: 1.5rem;
      letter-spacing: -1px;
    }

    .theme-switcher {
      display: flex;
      gap: 1rem;
    }

    .theme-switcher button {
      background-color: var(--dark-blue);
      color: var(--white);
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 600;
      transition: background-color 0.3s ease, transform 0.1s ease;
      font-size: 0.875rem;
    }

    .theme-switcher button:hover {
      background-color: var(--highlight-color);
      transform: translateY(-2px);
    }

    .theme-switcher button.active {
      background-color: var(--highlight-color);
    }

    .main-content {
      display: grid;
      grid-template-columns: 1fr;
      gap: 2rem;
    }

    .card {
      background-color: var(--white);
      padding: 2rem;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 25px rgba(0, 0, 0, .2);
    }

    .search-form {
      display: flex;
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .search-form input[type="text"] {
      flex-grow: 1;
      padding: 0.75rem 1.25rem;
      border: 2px solid var(--light-gray);
      border-radius: 12px;
      transition: border-color 0.3s ease;
    }

    .search-form input[type="text"]:focus {
      outline: none;
      border-color: var(--highlight-color);
    }

    .search-form button {
      padding: 0.75rem 1.5rem;
      background-color: var(--main-blue);
      color: var(--white);
      border: none;
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.3s ease, transform 0.1s ease;
    }

    .search-form button:hover {
      background-color: var(--dark-blue);
      transform: translateY(-2px);
    }

    .search-form button:disabled {
        background-color: var(--muted-text);
        cursor: not-allowed;
    }

    .message-box {
      background-color: #fce8e6;
      color: #9d2e1b;
      padding: 1rem;
      border-radius: 12px;
      margin-bottom: 1.5rem;
      display: none;
      font-weight: 500;
      border: 1px solid #f9c2bd;
    }

    h1, h2, h3 {
      font-weight: 700;
      color: var(--dark-blue);
      margin-bottom: 1rem;
      letter-spacing: -0.5px;
    }

    .proposta-info p {
      margin-bottom: 0.75rem;
    }

    .proposta-info p strong {
      color: var(--main-blue);
    }

    .tabela-precos {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1.5rem;
    }

    .tabela-precos th, .tabela-precos td {
      text-align: left;
      padding: 1rem;
      border-bottom: 1px solid var(--light-gray);
    }

    .tabela-precos th {
      background-color: var(--light-gray);
      color: var(--muted-text);
      font-weight: 600;
      text-transform: uppercase;
      font-size: 0.85rem;
    }

    .tabela-precos tbody tr:hover {
      background-color: #f7f9fc;
    }

    .tabela-precos .total {
      font-weight: 700;
      color: var(--dark-blue);
    }

    .resumo {
      margin-top: 2rem;
      padding-top: 2rem;
      border-top: 2px dashed var(--light-gray);
    }

    .resumo-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem 0;
      border-bottom: 1px solid var(--light-gray);
    }

    .resumo-item:last-child {
      border-bottom: none;
    }

    .resumo-item h4 {
      margin: 0;
      color: var(--main-blue);
    }

    .resumo-item span {
      font-weight: 600;
      color: var(--dark-blue);
      font-size: 1.1rem;
    }

    .link-pdf {
      display: inline-block;
      margin-top: 2rem;
      padding: 1rem 2rem;
      background-color: var(--highlight-color);
      color: var(--white);
      text-decoration: none;
      border-radius: 12px;
      font-weight: 700;
      text-align: center;
      transition: background-color 0.3s ease, transform 0.1s ease;
    }

    .link-pdf:hover {
      background-color: #e56d20;
      transform: translateY(-2px);
    }

    .hidden {
      display: none;
    }

    @media (max-width: 768px) {
      .container {
        padding: 1rem;
      }

      .header {
        flex-direction: column;
        gap: 1rem;
      }

      .search-form {
        flex-direction: column;
        gap: 0.5rem;
      }
    }
  </style>
</head>
<body>

  <div class="container">
    <header class="header">
      <div class="logo">GDIS Solar</div>
      <div class="theme-switcher">
        <button id="high-performance-option" class="active">Alta Performance</button>
        <button id="economic-option">Econômico</button>
      </div>
    </header>

    <main class="main-content">
      <div class="card">
        <h2>Consulta de Proposta</h2>
        <form id="search-form" class="search-form">
          <input type="text" id="project-id-input" placeholder="Digite o ID do Projeto..." required>
          <button type="submit">Consultar Proposta</button>
        </form>
        <div id="message-box" class="message-box" style="display: none;"></div>
      </div>

      <!-- Seção da Proposta (Inicialmente oculta) -->
      <div id="proposta-section" class="card hidden">
        <div class="proposta-info">
          <h3 id="proposta-nome"></h3>
          <p><strong>Status:</strong> <span id="proposta-status"></span></p>
          <p><strong>Data de Geração:</strong> <span id="proposta-geracao"></span></p>
        </div>

        <div class="proposta-detalhes">
          <h3>Tabela de Preços</h3>
          <table class="tabela-precos">
            <thead>
              <tr>
                <th>Categoria</th>
                <th>Item</th>
                <th>Qnt</th>
                <th>Custo Unitário</th>
                <th>Custo Total</th>
              </tr>
            </thead>
            <tbody id="pricing-table-body">
            </tbody>
          </table>
        </div>

        <div class="resumo">
          <h3>Resumo Financeiro</h3>
          <div class="resumo-item">
            <h4>Valor Total da Proposta</h4>
            <span id="valor-total-proposta"></span>
          </div>
          <div class="resumo-item">
            <h4>Geração Mensal Média</h4>
            <span id="geracao-media-mensal"></span>
          </div>
          <div class="resumo-item">
            <h4>Economia Anual Estimada</h4>
            <span id="economia-anual"></span>
          </div>
        </div>
        
        <div id="link-section" class="hidden">
            <a href="#" id="pdf-link" class="link-pdf" target="_blank">Ver Proposta em PDF</a>
        </div>
      </div>
    </main>
  </div>

  <script>
    // Seletores de elementos
    const highPerformanceOption = document.getElementById('high-performance-option');
    const economicOption = document.getElementById('economic-option');
    const searchForm = document.getElementById('search-form');
    const projectIdInput = document.getElementById('project-id-input');
    const messageBox = document.getElementById('message-box');
    const propostaSection = document.getElementById('proposta-section');
    const propostaNome = document.getElementById('proposta-nome');
    const propostaStatus = document.getElementById('proposta-status');
    const propostaGeracao = document.getElementById('proposta-geracao');
    const pricingTableBody = document.getElementById('pricing-table-body');
    const valorTotalProposta = document.getElementById('valor-total-proposta');
    const geracaoMediaMensal = document.getElementById('geracao-media-mensal');
    const economiaAnual = document.getElementById('economia-anual');
    const pdfLink = document.getElementById('pdf-link');
    const linkSection = document.getElementById('link-section');

    // Funções utilitárias
    function setTheme(theme) {
      document.body.className = theme === 'economico' ? 'economic-theme' : '';
      highPerformanceOption.classList.toggle('active', theme === 'alta_performance');
      economicOption.classList.toggle('active', theme === 'economico');
    }

    // Configuração do tema inicial
    setTheme('alta_performance');
    highPerformanceOption.addEventListener('click', () => setTheme('alta_performance'));
    economicOption.addEventListener('click', () => setTheme('economico'));


    /**
     * Consulta a proposta ativa de um cliente chamando o backend.
     * @param {string} projectId - O ID do projeto.
     * @returns {Promise<Object|null>} Um objeto com a proposta ou null em caso de falha.
     */
    async function consultarProposta(projectId) {
        const backendUrl = `https://gdissolarproposta.vercel.app/api/proposta?projectId=${projectId}`;
        
        try {
            const res = await fetch(backendUrl);
            
            if (!res.ok) {
                let errorMessage = `Erro HTTP: ${res.status}`;
                try {
                    const errorBody = await res.json();
                    if (errorBody && errorBody.error) {
                        errorMessage = `Erro: ${errorBody.error}`;
                    } else if (errorBody && errorBody.message) {
                        errorMessage = `Erro: ${errorBody.message}`;
                    }
                } catch (e) {
                    // Se não for um JSON válido, a mensagem genérica será mantida
                }
                throw new Error(errorMessage);
            }
            
            const dados = await res.json();
            // CORREÇÃO: A API de backend já retorna a proposta diretamente,
            // então não precisamos mais acessar a propriedade 'data'.
            return dados;
        } catch (err) {
            console.error("Erro ao consultar proposta:", err);
            throw err;
        }
    }

    /**
     * Renderiza os dados da proposta na interface do usuário.
     * @param {object} proposta - Objeto contendo os dados da proposta.
     */
    function renderizarProposta(proposta) {
        // Exibe a seção da proposta
        propostaSection.classList.remove('hidden');

        // Renderiza as informações principais
        propostaNome.textContent = proposta.name || 'Nome da Proposta Não Disponível';
        propostaStatus.textContent = proposta.status || 'Status Não Disponível';
        
        // Formata a data de geração
        if (proposta.generatedAt) {
            const dataGeracao = new Date(proposta.generatedAt);
            propostaGeracao.textContent = dataGeracao.toLocaleDateString('pt-BR');
        } else {
            propostaGeracao.textContent = 'Data não disponível';
        }

        // Limpa a tabela de preços antes de preencher
        pricingTableBody.innerHTML = '';
        
        // Renderiza a tabela de preços
        const pricingTable = proposta.pricingTable || [];
        if (pricingTable.length > 0) {
            pricingTable.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.category || ''}</td>
                    <td>${item.item || ''}</td>
                    <td>${item.qnt || ''}</td>
                    <td>R$ ${typeof item.unitCost === 'number' ? item.unitCost.toFixed(2).replace('.', ',') : ''}</td>
                    <td>R$ ${typeof item.totalCost === 'number' ? item.totalCost.toFixed(2).replace('.', ',') : ''}</td>
                `;
                pricingTableBody.appendChild(row);
            });
        } else {
            const row = document.createElement('tr');
            row.innerHTML = `<td colspan="5">Nenhum item de preço encontrado.</td>`;
            pricingTableBody.appendChild(row);
        }

        // Renderiza o resumo financeiro
        const summary = proposta.summary || {};
        if (Object.keys(summary).length > 0) {
            valorTotalProposta.textContent = `R$ ${typeof summary.proposalTotalCost === 'number' ? summary.proposalTotalCost.toFixed(2).replace('.', ',') : ''}`;
            geracaoMediaMensal.textContent = `${typeof summary.avgGeneration === 'number' ? summary.avgGeneration.toFixed(2).replace('.', ',') : ''} kWh`;
            economiaAnual.textContent = `R$ ${typeof summary.annualSavings === 'number' ? summary.annualSavings.toFixed(2).replace('.', ',') : ''}`;
        } else {
            valorTotalProposta.textContent = 'Não disponível';
            geracaoMediaMensal.textContent = 'Não disponível';
            economiaAnual.textContent = 'Não disponível';
        }

        // Lida com o link do PDF
        if (proposta.linkPdf) {
            pdfLink.href = proposta.linkPdf;
            linkSection.classList.remove('hidden');
        } else {
            linkSection.classList.add('hidden');
        }
    }

    // Lida com o envio do formulário
    searchForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const projectId = projectIdInput.value.trim();
        
        // Limpa a caixa de mensagens
        messageBox.style.display = 'none';
        messageBox.textContent = '';
        
        if (!projectId) {
            messageBox.textContent = 'Por favor, digite um ID de projeto.';
            messageBox.style.display = 'block';
            return;
        }

        // Simula um estado de carregamento
        searchForm.querySelector('button').textContent = 'Consultando...';
        searchForm.querySelector('button').disabled = true;

        try {
            const proposta = await consultarProposta(projectId);
            if (proposta) {
                renderizarProposta(proposta);
            } else {
                messageBox.textContent = 'Proposta não encontrada para o projeto especificado.';
                messageBox.style.display = 'block';
            }
        } catch (err) {
            messageBox.textContent = `Erro ao carregar proposta: ${err.message}`;
            messageBox.style.display = 'block';
        } finally {
            searchForm.querySelector('button').textContent = 'Consultar Proposta';
            searchForm.querySelector('button').disabled = false;
        }
    });
  </script>

</body>
</html>
