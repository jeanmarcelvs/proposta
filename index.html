<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GDIS Solar - Proposta</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap">
  <style>
    /* ---------------------- */
    /* Cores e Variáveis      */
    /* ---------------------- */
    :root {
      /* Tema padrão: Alta Performance */
      --main-blue: #123d8c;
      --dark-blue: #0a2a5c;
      --highlight-color: #ff7a29;
      --secondary-highlight: #ff7a29;
      --white: #ffffff;
      --light-gray: #f4f6fb;
      --muted-text: #6f7d95;
      --nav-bg: rgba(18, 61, 140, 0.9);
      --gradient-bg: linear-gradient(135deg, var(--main-blue) 0%, var(--dark-blue) 50%, #174296 100%);
      --radius: 22px;
      --shadow: 0 8px 20px rgba(0, 0, 0, .15);
    }

    body.economic-theme {
      /* NOVO TEMA: Econômico */
      --main-blue: #598c76;
      --dark-blue: #315e4a;
      --highlight-color: #79c9a0;
      --secondary-highlight: #598c76;
      --white: #ffffff;
      --light-gray: #f7faf7;
      --muted-text: #6f7d95;
      --nav-bg: rgba(89, 140, 118, 0.9);
      --gradient-bg: linear-gradient(135deg, var(--main-blue) 0%, var(--dark-blue) 50%, #4c6f5d 100%);
    }

    /* ---------------------- */
    /* Estilos Gerais         */
    /* ---------------------- */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', sans-serif;
      line-height: 1.6;
      transition: background-color 0.5s ease;
      color: var(--dark-blue);
      background: var(--light-gray);
    }

    /* Esconde as seções de proposta por padrão */
    .proposal-container {
        display: none;
        background: var(--light-gray);
        color: var(--dark-blue);
    }
    
    .proposal-section {
        display: none;
    }

    /* Estilos para o container do formulário */
    .form-container {
        background: var(--gradient-bg);
        color: var(--white);
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        flex-direction: column;
        transition: background 0.5s ease;
    }

    .form-box {
      width: 100%;
      max-width: 500px;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      padding: 40px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      text-align: center;
    }

    .form-box .logo img {
      height: 80px;
      margin-bottom: 20px;
    }

    .form-box h1 {
      font-size: clamp(28px, 5vw, 40px);
      font-weight: 800;
      margin-bottom: 10px;
    }

    .form-box p {
      font-size: 16px;
      margin-bottom: 30px;
      opacity: 0.8;
    }

    .search-form {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .search-form input[type="text"] {
      width: 100%;
      padding: 15px 20px;
      border-radius: 50px;
      border: none;
      font-size: 16px;
      background: rgba(255, 255, 255, 0.2);
      color: var(--white);
      transition: background 0.3s ease;
    }

    .search-form input[type="text"]::placeholder {
      color: rgba(255, 255, 255, 0.7);
    }

    .search-form input[type="text"]:focus {
      outline: none;
      background: rgba(255, 255, 255, 0.3);
    }

    .search-form button {
      width: 100%;
      padding: 15px 20px;
      border-radius: 50px;
      border: none;
      font-size: 18px;
      font-weight: 700;
      cursor: pointer;
      background: var(--highlight-color);
      color: var(--white);
      transition: background 0.3s ease, transform 0.1s;
    }

    .search-form button:hover {
      background: var(--secondary-highlight);
    }

    .search-form button:active {
      transform: translateY(1px);
    }
    
    .message-box {
        margin-top: 20px;
        padding: 15px;
        background: rgba(255, 0, 0, 0.2);
        border-radius: 8px;
        display: none;
        font-size: 14px;
        font-weight: 500;
        border: 1px solid rgba(255, 0, 0, 0.4);
    }

    /* ---------------------- */
    /* Componentes da Proposta*/
    /* ---------------------- */
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    .clean-section {
      background: var(--white);
      margin: 40px 0;
      padding: 60px 20px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      transition: background-color 0.5s ease;
    }

    section {
      position: relative;
      overflow: hidden;
    }

    .payback-section-bg {
      background: var(--dark-blue);
      color: var(--white);
      margin: 40px 0;
      padding: 60px 20px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      transition: background-color 0.5s ease;
    }

    .payback-section-bg h2 {
      color: var(--white);
    }

    section h2 {
      text-align: center;
      font-size: clamp(28px, 4vw, 40px);
      margin-bottom: 12px;
      color: var(--dark-blue);
      font-weight: 700;
      transition: color 0.5s ease;
    }

    section p.lead {
      text-align: center;
      color: var(--muted-text);
      margin-bottom: 40px;
      font-size: 18px;
      transition: color 0.5s ease;
    }

    .grid {
      display: grid;
      gap: 30px;
    }

    .grid-2 {
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    }

    .grid-3 {
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    }

    .card {
      background: var(--white);
      border-radius: var(--radius);
      padding: 30px;
      box-shadow: var(--shadow);
      transition: all .3s ease, background-color 0.5s ease;
    }

    .card:hover {
      transform: translateY(-5px);
    }

    .text-center {
      text-align: center;
    }

    .nav-bar {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      background: var(--nav-bg);
      padding: 20px 30px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      z-index: 1000;
      display: flex;
      flex-direction: row;
      justify-content: space-between;
      align-items: center;
      transition: background 0.5s ease;
      display: none; /* Esconde o cabeçalho por padrão */
    }

    .nav-bar .logo {
      display: flex;
      align-items: center;
    }

    .nav-bar img {
      height: 60px;
    }

    .nav-middle-content {
      display: flex;
      flex: 1;
      justify-content: center;
      align-items: center;
      gap: 20px;
    }

    .header-prices-info {
      max-width: 0;
      opacity: 0;
      overflow: hidden;
      display: flex;
      align-items: center;
      gap: 20px;
      transition: max-width 0.6s ease, opacity 0.6s ease;
      flex-shrink: 0;
    }

    .nav-bar.show-prices .header-prices-info {
      max-width: 500px;
      opacity: 1;
    }

    .price-group {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
    }

    .price-label {
      font-size: 12px;
      text-transform: uppercase;
      color: var(--white);
      opacity: 0.7;
    }

    .price-value {
      font-size: 18px;
      font-weight: 600;
      color: var(--white);
    }

    .options-row {
      display: flex;
      gap: 15px;
    }

    .option {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(5px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 50px;
      color: var(--white);
      padding: 10px 25px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .option.selected {
      background: var(--white);
      color: var(--main-blue);
      border-color: var(--white);
    }
    
    .nav-buttons-mobile {
        display: none;
    }

    @media (max-width: 768px) {
      .nav-bar {
        flex-direction: column;
        align-items: flex-start;
        padding: 15px;
      }
      
      .nav-middle-content {
          flex-direction: column;
          align-items: flex-start;
          gap: 10px;
      }

      .options-row {
          flex-wrap: wrap;
          justify-content: center;
      }
      
      .header-prices-info {
          flex-direction: column;
          align-items: flex-start;
          gap: 10px;
      }
      
      .price-group {
          align-items: flex-start;
      }
      
      .nav-buttons-mobile {
        display: flex;
        width: 100%;
        justify-content: center;
        gap: 10px;
      }
      
      .options-row {
          display: none;
      }
      
      .nav-bar.show-prices .header-prices-info {
          max-width: 100%;
      }
    }
    
    .table-responsive {
        overflow-x: auto;
    }
    
    table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0 15px; /* Espaço entre as linhas */
    }
    
    table thead th {
        text-align: left;
        padding: 10px 15px;
        font-size: 14px;
        text-transform: uppercase;
        color: var(--muted-text);
        font-weight: 600;
    }
    
    table tbody tr {
        background: var(--light-gray);
        border-radius: 15px;
        overflow: hidden;
        transition: all 0.3s ease;
    }

    table tbody tr:hover {
        transform: translateY(-3px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
    }
    
    table tbody td {
        padding: 15px;
        color: var(--dark-blue);
        font-weight: 500;
        vertical-align: middle;
    }
    
    table tbody tr:first-child {
        border-top-left-radius: var(--radius);
        border-top-right-radius: var(--radius);
    }
    
    table tbody tr:last-child {
        border-bottom-left-radius: var(--radius);
        border-bottom-right-radius: var(--radius);
    }
    
    .table-header {
        text-align: center;
        margin-bottom: 20px;
    }
    
    .pricing-table-section {
        margin: 40px 0;
        padding: 20px;
    }

    .pricing-table-section h2 {
        text-align: left;
        font-size: clamp(24px, 3vw, 36px);
        margin-bottom: 12px;
        color: var(--dark-blue);
    }
    
    .pricing-table-section p {
        text-align: left;
        color: var(--muted-text);
        margin-bottom: 30px;
    }

    /* Rodapé */
    footer {
        text-align: center;
        padding: 20px;
        color: var(--muted-text);
        font-size: 14px;
        background: var(--white);
        margin-top: 40px;
    }

  </style>
</head>

<body>
  <!-- Seção de Consulta (Padrão) -->
  <div id="form-section" class="form-container">
    <div class="form-box">
      <div class="logo">
        <img src="logo.png" onerror="this.onerror=null;this.src='https://placehold.co/150x80/123d8c/ffffff?text=Logo';" alt="Logo GDIS Solar">
      </div>
      <h1>Sua Proposta GDIS Solar</h1>
      <p>Digite o ID do projeto para visualizar a proposta.</p>
      <form id="search-form" class="search-form">
        <input type="text" id="project-id" name="project-id" placeholder="Ex: 123456" required>
        <button type="submit">Consultar</button>
      </form>
      <div id="message-box" class="message-box"></div>
    </div>
  </div>
  
  <!-- Seção da Proposta (Escondida por padrão) -->
  <div id="proposal-section" class="proposal-container">
    <!-- Cabeçalho Fixo -->
    <header class="nav-bar">
      <div class="nav-bar-left">
        <div class="logo">
          <img src="logo.png" onerror="this.onerror=null;this.src='https://placehold.co/150x80/123d8c/ffffff?text=Logo';" alt="Logo GDIS Solar">
        </div>
      </div>
      <div class="nav-middle-content">
          <div class="header-prices-info">
              <div class="price-group">
                  <span class="price-label">À vista</span>
                  <span id="nav-bar-avista-price" class="price-value">R$ 0,00</span>
              </div>
              <div class="price-group">
                  <span class="price-label">Mensal</span>
                  <span id="nav-bar-min-parcel" class="price-value">R$ 0,00</span>
              </div>
          </div>
          <div class="options-row">
              <div class="option high-performance-option selected">
                  <span>Alta Performance</span>
              </div>
              <div class="option economic-option">
                  <span>Econômico</span>
              </div>
          </div>
      </div>
    </header>

    <!-- Seção de Cabeçalho da Proposta -->
    <section class="clean-section header-section proposal-section">
      <div class="container">
        <h2 id="project-name"></h2>
        <p class="lead" id="project-description"></p>
        <div class="grid grid-3">
          <!-- Card de Pagamento à Vista -->
          <div class="card text-center">
            <span style="font-size: 14px; color: var(--muted-text);">Pagamento à vista</span>
            <h3 id="pagamento-vista" style="font-size: 32px; font-weight: 800; color: var(--highlight-color); margin-top: 10px;">R$ 0,00</h3>
          </div>
          <!-- Card de Parcela Mínima -->
          <div class="card text-center">
            <span style="font-size: 14px; color: var(--muted-text);">Pagamento com parcela mínima</span>
            <h3 id="pagamento-parcela-minima" style="font-size: 32px; font-weight: 800; color: var(--highlight-color); margin-top: 10px;">R$ 0,00</h3>
          </div>
          <!-- Card de Payback -->
          <div class="card text-center">
            <span style="font-size: 14px; color: var(--muted-text);">Payback estimado</span>
            <h3 id="payback-years" style="font-size: 32px; font-weight: 800; color: var(--highlight-color); margin-top: 10px;">0 anos</h3>
          </div>
        </div>
      </div>
    </section>

    <!-- Seção de Tabela de Preços -->
    <section class="pricing-table-section proposal-section">
      <div class="container">
        <h2>Detalhes da Proposta</h2>
        <p>A tabela de preços detalhada para cada componente do seu projeto.</p>
        <div class="table-responsive">
          <table id="pricing-table">
            <thead>
              <tr>
                <th>Categoria</th>
                <th>Item</th>
                <th>Quantidade</th>
                <th>Custo Unitário</th>
                <th>Custo Total</th>
              </tr>
            </thead>
            <tbody>
              <!-- Os itens da tabela serão inseridos aqui via JavaScript -->
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Rodapé -->
    <footer>
      <p>Desenvolvido por GDIS Solar. © 2024</p>
    </footer>

  </div>

  <script>
    // Seletor de elementos HTML para fácil acesso
    const formSection = document.getElementById('form-section');
    const proposalSection = document.getElementById('proposal-section');
    const navBar = document.querySelector('.nav-bar');
    const searchForm = document.getElementById('search-form');
    const messageBox = document.getElementById('message-box');
    const projectIdInput = document.getElementById('project-id');
    const navBarAvistaPrice = document.getElementById('nav-bar-avista-price');
    const navBarMinParcel = document.getElementById('nav-bar-min-parcel');
    const projectNameEl = document.getElementById('project-name');
    const projectDescriptionEl = document.getElementById('project-description');
    const pagamentoVistaEl = document.getElementById('pagamento-vista');
    const pagamentoParcelaMinima = document.getElementById('pagamento-parcela-minima');
    const paybackYears = document.getElementById('payback-years');
    const pricingTableBody = document.querySelector('#pricing-table tbody');
    const highPerformanceOption = document.querySelector('.high-performance-option');
    const economicOption = document.querySelector('.economic-option');
    const proposalSections = document.querySelectorAll('.proposal-section');

    // Mapeia os temas e suas classes
    const themes = {
      alta_performance: {
        bodyClass: '',
        activeOptionClass: 'selected'
      },
      economico: {
        bodyClass: 'economic-theme',
        activeOptionClass: 'selected'
      }
    };

    /**
     * Lida com o evento de envio do formulário.
     * @param {Event} event - O evento de envio.
     */
    searchForm.addEventListener('submit', async function(event) {
      event.preventDefault();
      const projectId = projectIdInput.value.trim();
      
      messageBox.style.display = 'none';

      if (!projectId) {
        showMessage('Por favor, digite o ID do projeto.', 'error');
        return;
      }
      
      showLoading(true);

      try {
        const proposta = await consultarProposta(projectId);
        if (proposta) {
          preencherProposta(proposta);
          showProposal(true);
        } else {
          showMessage('Nenhuma proposta encontrada para este projeto.', 'error');
          showProposal(false);
        }
      } catch (err) {
        showMessage(`Erro: ${err.message}`, 'error');
        showProposal(false);
      } finally {
        showLoading(false);
      }
    });

    /**
     * Alterna a visibilidade das seções.
     * @param {boolean} show - Se true, mostra a proposta; se false, mostra o formulário.
     */
    function showProposal(show) {
      if (show) {
        formSection.style.display = 'none';
        proposalSection.style.display = 'block';
        navBar.style.display = 'flex';
        proposalSections.forEach(section => section.style.display = 'block');
      } else {
        formSection.style.display = 'flex';
        proposalSection.style.display = 'none';
        navBar.style.display = 'none';
      }
    }
    
    /**
     * Alterna a visibilidade do botão de loading.
     * @param {boolean} show - Se true, mostra o loading; se false, mostra o botão original.
     */
    function showLoading(show) {
        const button = searchForm.querySelector('button');
        if (show) {
            button.disabled = true;
            button.textContent = 'Carregando...';
            button.style.cursor = 'wait';
        } else {
            button.disabled = false;
            button.textContent = 'Consultar';
            button.style.cursor = 'pointer';
        }
    }
    
    /**
     * Exibe uma mensagem de erro ou sucesso na caixa de mensagem.
     * @param {string} message - A mensagem a ser exibida.
     * @param {string} type - 'success' ou 'error'.
     */
    function showMessage(message, type) {
      messageBox.textContent = message;
      messageBox.style.display = 'block';
      if (type === 'error') {
        messageBox.style.backgroundColor = 'rgba(255, 0, 0, 0.2)';
        messageBox.style.borderColor = 'rgba(255, 0, 0, 0.4)';
        messageBox.style.color = '#fff';
      } else {
        messageBox.style.backgroundColor = 'rgba(0, 128, 0, 0.2)';
        messageBox.style.borderColor = 'rgba(0, 128, 0, 0.4)';
        messageBox.style.color = '#fff';
      }
    }

    /**
     * Preenche a página com os dados da proposta.
     * @param {Object} proposta - O objeto da proposta retornado pela API.
     */
    function preencherProposta(proposta) {
      const { data } = proposta;
      
      // Preenche os dados principais da proposta
      projectNameEl.textContent = data.project.name || 'Nome do Projeto Não Encontrado';
      projectDescriptionEl.textContent = data.description || '';
      pagamentoVistaEl.textContent = (data.pricingTable[0].totalCost || 0).toLocaleString("pt-BR", { minimumFractionDigits: 2, style: 'currency', currency: 'BRL' });
      
      const propostaVars = data.variables;
      const valorParcela = propostaVars.find(v => v.key === 'vc_valor_parcela')?.value;
      const paybackAnos = propostaVars.find(v => v.key === 'vc_payback_anos')?.value;

      pagamentoParcelaMinima.textContent = `R$ ${parseFloat(valorParcela).toLocaleString("pt-BR", { minimumFractionDigits: 2 })}`;
      paybackYears.textContent = `${paybackAnos || 4} anos`;

      // Preenche o cabeçalho
      navBarAvistaPrice.textContent = (data.pricingTable[0].totalCost || 0).toLocaleString("pt-BR", { minimumFractionDigits: 2, style: 'currency', currency: 'BRL' });
      navBarMinParcel.textContent = `R$ ${parseFloat(valorParcela).toLocaleString("pt-BR", { minimumFractionDigits: 2 })}`;

      // Preenche a tabela de preços
      pricingTableBody.innerHTML = '';
      data.pricingTable.forEach(item => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${item.category}</td>
          <td>${item.item}</td>
          <td>${item.qnt}</td>
          <td>${(item.unitCost || 0).toLocaleString("pt-BR", { minimumFractionDigits: 2, style: 'currency', currency: 'BRL' })}</td>
          <td>${(item.totalCost || 0).toLocaleString("pt-BR", { minimumFractionDigits: 2, style: 'currency', currency: 'BRL' })}</td>
        `;
        pricingTableBody.appendChild(row);
      });
      
      // Define o tema inicial como "alta performance"
      setTheme('alta_performance');
    }

    /**
     * Altera o tema da página.
     * @param {string} themeName - O nome do tema ('alta_performance' ou 'economico').
     */
    function setTheme(themeName) {
      document.body.classList.remove(themes.economico.bodyClass);
      document.body.classList.add(themes[themeName].bodyClass);
      
      highPerformanceOption.closest('.option').classList.remove('selected');
      economicOption.closest('.option').classList.remove('selected');

      if (themeName === 'alta_performance') {
        highPerformanceOption.closest('.option').classList.add('selected');
      } else if (themeName === 'economico') {
        economicOption.closest('.option').classList.add('selected');
      }
    }
    
    // Adiciona event listeners para os botões de tema
    highPerformanceOption.addEventListener('click', () => setTheme('alta_performance'));
    economicOption.addEventListener('click', () => setTheme('economico'));


    /**
     * Consulta a proposta ativa de um cliente chamando o backend.
     * @param {string} projectId - O ID do projeto.
     * @returns {Promise<Object|null>} Um objeto com a proposta ou null em caso de falha.
     */
    async function consultarProposta(projectId) {
        const backendUrl = `https://gdissolarproposta.vercel.app/api/proposta?projectId=${projectId}`;
        
        try {
            const res = await fetch(backendUrl);
            
            if (!res.ok) {
                let errorMessage = `Erro HTTP: ${res.status}`;
                try {
                    const errorBody = await res.json();
                    if (errorBody && errorBody.error) {
                        errorMessage = `Erro: ${errorBody.error}`;
                    } else if (errorBody && errorBody.message) {
                        errorMessage = `Erro: ${errorBody.message}`;
                    }
                } catch (e) {
                    // Se não for um JSON válido, a mensagem genérica será mantida
                }
                throw new Error(errorMessage);
            }
            
            const dados = await res.json();
            return dados;
        } catch (err) {
            console.error("Erro ao consultar proposta:", err);
            throw err;
        }
    }
  </script>

</body>
</html>
